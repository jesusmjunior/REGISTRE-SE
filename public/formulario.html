import React from 'react';
import { AlertCircle, CheckCircle, Info, X, Eye, Edit2, Trash2, RefreshCw, Search, Save, FileText, List, ArrowUp } from 'lucide-react';

// Configuração da API
const API_CONFIG = {
  URL: 'https://script.google.com/macros/s/AKfycbwRjX5DOrbMGKeEbxGB7tHJ2IsSi6zaUOUqXZ13b02mlIeP8OxziECpJMx46MLYRpGiHg/exec',
};

// Lista de serventias
const SERVENTIAS = [
  "Cartório da 1ª Zona de Registro de Imóveis de São Luis",
  "Cartório do ofício Único de Poção de Pedras",
  // ... additional items...
].sort();

const CogexRegistreApp = () => {
  // Estado para controle de abas
  const [activeTab, setActiveTab] = React.useState('form');
  
  // Estado para a lista de registros
  const [registros, setRegistros] = React.useState([]);
  const [isLoading, setIsLoading] = React.useState(false);
  const [searchTerm, setSearchTerm] = React.useState('');
  const [filteredRegistros, setFilteredRegistros] = React.useState([]);
  
  // Estados para modais
  const [viewModal, setViewModal] = React.useState({ show: false, data: null, readonly: true });
  const [deleteModal, setDeleteModal] = React.useState({ show: false, id: null });
  
  // Estado para notificações toast
  const [toasts, setToasts] = React.useState([]);

  // Efeitos
  React.useEffect(() => {
    // Carregar registros se a aba ativa for 'list'
    if (activeTab === 'list') {
      loadRegistros();
    }
  }, [activeTab]);
  
  // Efeito para filtrar registros de acordo com o termo de busca
  React.useEffect(() => {
    if (registros.length > 0 && searchTerm) {
      const term = searchTerm.toLowerCase();
      const filtered = registros.filter(reg => {
        return (
          (reg.Serventia && reg.Serventia.toLowerCase().includes(term)) ||
          (reg.Responsável && reg.Responsável.toLowerCase().includes(term)) ||
          (reg.Participação && reg.Participação.toLowerCase().includes(term)) ||
          (reg.ID && reg.ID.toString().includes(term))
        );
      });
      setFilteredRegistros(filtered);
    } else {
      setFilteredRegistros(registros);
    }
  }, [searchTerm, registros]);

  // Funções para o sistema de notificações toast
  const addToast = (message, type = 'info') => {
    const id = Date.now();
    setToasts([...toasts, { id, message, type }]);
    
    // Auto-remover após 5 segundos
    setTimeout(() => {
      setToasts(prevToasts => prevToasts.filter(toast => toast.id !== id));
    }, 5000);
  };
  
  const removeToast = (id) => {
    setToasts(prevToasts => prevToasts.filter(toast => toast.id !== id));
  };
  
  // Funções para lidar com a listagem de registros
  const loadRegistros = async () => {
    setIsLoading(true);
    
    try {
      const response = await fetch(`${API_CONFIG.URL}?action=getAll`);
      
      if (!response.ok) {
        throw new Error(`Erro HTTP: ${response.status}`);
      }
      
      const result = await response.json();
      
      if (result.success) {
        // Ordenar por ID (mais recentes primeiro)
        const sortedRegistros = result.data.sort((a, b) => parseInt(b.ID) - parseInt(a.ID));
        setRegistros(sortedRegistros);
        setFilteredRegistros(sortedRegistros);
      } else {
        throw new Error(result.message || 'Erro ao carregar registros');
      }
    } catch (error) {
      addToast(`Erro ao carregar registros: ${error.message}`, 'error');
      console.error('Erro ao carregar registros:', error);
    } finally {
      setIsLoading(false);
    }
  };
  
  const handleSearch = () => {
    // A filtragem é feita pelo useEffect que observa searchTerm
  };
  
  const handleRefresh = () => {
    setSearchTerm('');
    loadRegistros();
  };
  
  const highlightRow = (id) => {
    // Implementar destaque visual para a linha com o ID específico
    const row = document.querySelector(`tr[data-id="${id}"]`);
    if (row) {
      row.classList.add('highlight-row');
      row.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
  };
  
  // Funções para modais
  const handleViewRegistro = async (id) => {
    try {
      setIsLoading(true);
      
      const response = await fetch(`${API_CONFIG.URL}?action=getRegistro&id=${id}`);
      
      if (!response.ok) {
        throw new Error(`Erro HTTP: ${response.status}`);
      }
      
      const result = await response.json();
      
      if (result.success) {
        setViewModal({
          show: true,
          data: result.data,
          readonly: true
        });
      } else {
        throw new Error(result.message || 'Erro ao carregar registro');
      }
    } catch (error) {
      addToast(`Erro ao visualizar: ${error.message}`, 'error');
      console.error('Erro ao visualizar registro:', error);
    } finally {
      setIsLoading(false);
    }
  };
  
  const handleEditRegistro = async (id) => {
    try {
      setIsLoading(true);
      
      const response = await fetch(`${API_CONFIG.URL}?action=getRegistro&id=${id}`);
      
      if (!response.ok) {
        throw new Error(`Erro HTTP: ${response.status}`);
      }
      
      const result = await response.json();
      
      if (result.success) {
        setViewModal({
          show: true,
          data: result.data,
          readonly: false
        });
      } else {
        throw new Error(result.message || 'Erro ao carregar registro');
      }
    } catch (error) {
      addToast(`Erro ao editar: ${error.message}`, 'error');
      console.error('Erro ao editar registro:', error);
    } finally {
      setIsLoading(false);
    }
  };
  
  const handleSaveEdit = async () => {
    try {
      setIsLoading(true);
      
      // Coletar dados do modal de edição
      const formEl = document.getElementById('editForm');
      if (!formEl) {
        throw new Error('Formulário de edição não encontrado');
      }
      
      const formData = new FormData(formEl);
      const data = {};
      
      for (let [key, value] of formData.entries()) {
        // Converter campos numéricos
        if (['Vias Emitidas', 'Registros Nascimento', 'Averbações Paternidade', 
             'Retificações', 'Registros Tardios', 'Restaurações'].includes(key)) {
          value = parseInt(value) || 0;
        }
        data[key] = value;
      }
      
      // Adicionar ID
      data.id = viewModal.data.ID;
      
      // Enviar para a API
      const response = await fetch(`${API_CONFIG.URL}?action=atualizarRegistro`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
      });
      
      if (!response.ok) {
        throw new Error(`Erro HTTP: ${response.status}`);
      }
      
      const result = await response.json();
      
      if (result.success) {
        addToast('Registro atualizado com sucesso!', 'success');
        setViewModal({ show: false, data: null, readonly: true });
        loadRegistros();
      } else {
        throw new Error(result.message || 'Erro ao atualizar registro');
      }
    } catch (error) {
      addToast(`Erro ao atualizar: ${error.message}`, 'error');
      console.error('Erro ao atualizar registro:', error);
    } finally {
      setIsLoading(false);
    }
  };
  
  const handleDeleteClick = (id) => {
    setDeleteModal({
      show: true,
      id
    });
  };
  
  const handleDeleteConfirm = async () => {
    try {
      setIsLoading(true);
      
      const id = deleteModal.id;
      
      const response = await fetch(`${API_CONFIG.URL}?action=excluirRegistro&id=${id}`, {
        method: 'GET'
      });
      
      if (!response.ok) {
        throw new Error(`Erro HTTP: ${response.status}`);
      }
      
      const result = await response.json();
      
      if (result.success) {
        addToast('Registro excluído com sucesso!', 'success');
        setDeleteModal({ show: false, id: null });
        loadRegistros();
      } else {
        throw new Error(result.message || 'Erro ao excluir registro');
      }
    } catch (error) {
      addToast(`Erro ao excluir: ${error.message}`, 'error');
      console.error('Erro ao excluir registro:', error);
    } finally {
      setIsLoading(false);
    }
  };

  // Componente para o formulário usando Formbricks
  const FormTab = () => (
    <div className="bg-white rounded-lg shadow-md p-6 my-6">
      <h2 className="text-2xl font-bold text-red-900 mb-4 pb-2 border-b-2 border-yellow-400">
        Formulário de Registro - Semana Registre-se
      </h2>
      <p className="text-gray-600 mb-6">
        Preencha os dados referentes à participação da sua serventia na Semana Registre-se.
      </p>
      
      <div style={{ position: 'relative', height: '80vh', overflow: 'auto' }}> 
        <iframe 
          src="https://app.formbricks.com/s/cm9yt74n672fqv901x9vrerw8" 
          frameBorder="0" 
          style={{ position: 'absolute', left: 0, top: 0, width: '100%', height: '100%', border: 0 }}
        />
      </div>
    </div>
  );
  
  // Componente para a lista de registros
  const ListTab = () => (
    <div className="bg-white rounded-lg shadow-md p-6 my-6">
      <h2 className="text-2xl font-bold text-red-900 mb-4 pb-2 border-b-2 border-yellow-400">
        Consulta de Registros
      </h2>
      
      <div className="flex flex-wrap gap-3 mb-6">
        <div className="flex-grow">
          <div className="flex">
            <input
              type="text"
              className="w-full p-2 border border-gray-300 rounded-l-md"
              placeholder="Pesquisar por serventia, responsável..."
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
              onKeyPress={(e) => e.key === 'Enter' && handleSearch()}
            />
            <button
              className="bg-red-900 text-white p-2 rounded-r-md hover:bg-red-700 transition"
              onClick={handleSearch}
            >
              <Search className="h-5 w-5" />
            </button>
          </div>
        </div>
        <button
          className="py-2 px-4 border border-red-900 text-red-900 rounded-md hover:bg-red-50 transition"
          onClick={handleRefresh}
        >
          <RefreshCw className="inline mr-2 h-4 w-4" />
          Atualizar
        </button>
      </div>
      
      {isLoading ? (
        <div className="text-center py-8">
          <div className="inline-block animate-spin rounded-full h-8 w-8 border-4 border-red-900 border-t-transparent"></div>
          <p className="mt-2 text-gray-600">Carregando registros...</p>
        </div>
      ) : filteredRegistros.length > 0 ? (
        <div className="overflow-x-auto">
          <table className="min-w-full border-collapse">
            <thead>
              <tr className="bg-red-900 text-white">
                <th className="px-4 py-3 text-left">ID</th>
                <th className="px-4 py-3 text-left">Serventia</th>
                <th className="px-4 py-3 text-left">Responsável</th>
                <th className="px-4 py-3 text-left">Participação</th>
                <th className="px-4 py-3 text-left">Registros</th>
                <th className="px-4 py-3 text-left">Data</th>
                <th className="px-4 py-3 text-left">Ações</th>
              </tr>
            </thead>
            <tbody>
              {filteredRegistros.map((registro) => {
                // Calcular total de registros
                const totalRegistros = (
                  parseInt(registro['Registros Nascimento'] || 0) +
                  parseInt(registro['Vias Emitidas'] || 0) +
                  parseInt(registro['Averbações Paternidade'] || 0) +
                  parseInt(registro['Retificações'] || 0) +
                  parseInt(registro['Registros Tardios'] || 0) +
                  parseInt(registro['Restaurações'] || 0)
                );
                
                // Formatar data
                let dataFormatada = 'N/A';
                if (registro['Timestamp']) {
                  try {
                    const data = new Date(registro['Timestamp']);
                    dataFormatada = data.toLocaleDateString('pt-BR');
                  } catch (e) {
                    console.error('Erro ao formatar data:', e);
                  }
                }
                
                return (
                  <tr 
                    key={registro.ID} 
                    data-id={registro.ID}
                    className="border-b border-gray-200 hover:bg-yellow-50 transition"
                  >
                    <td className="px-4 py-3">{registro.ID}</td>
                    <td className="px-4 py-3">{registro['Serventia'] || '—'}</td>
                    <td className="px-4 py-3">{registro['Responsável'] || '—'}</td>
                    <td className="px-4 py-3">
                      <span className={registro['Participação'] === 'Não' ? 'text-red-600' : 'text-green-600'}>
                        {registro['Participação'] || 'Sim'}
                      </span>
                    </td>
                    <td className="px-4 py-3">{totalRegistros}</td>
                    <td className="px-4 py-3">{dataFormatada}</td>
                    <td className="px-4 py-3 flex gap-1">
                      <button
                        className="p-1 bg-blue-500 text-white rounded hover:bg-blue-600 transition"
                        onClick={() => handleViewRegistro(registro.ID)}
                        title="Visualizar"
                      >
                        <Eye className="h-4 w-4" />
                      </button>
                      <button
                        className="p-1 bg-yellow-500 text-white rounded hover:bg-yellow-600 transition"
                        onClick={() => handleEditRegistro(registro.ID)}
                        title="Editar"
                      >
                        <Edit2 className="h-4 w-4" />
                      </button>
                      <button
                        className="p-1 bg-red-500 text-white rounded hover:bg-red-600 transition"
                        onClick={() => handleDeleteClick(registro.ID)}
                        title="Excluir"
                      >
                        <Trash2 className="h-4 w-4" />
                      </button>
                    </td>
                  </tr>
                );
              })}
            </tbody>
          </table>
        </div>
      ) : (
        <div className="bg-blue-50 text-blue-700 p-4 rounded-md border border-blue-200">
          <Info className="inline mr-2 h-5 w-5" />
          Nenhum registro encontrado.
        </div>
      )}
    </div>
  );
  
  // Componente para o sistema de notificações toast
  const Toast = ({ id, message, type, onClose }) => {
    let bgColor, icon;
    
    switch (type) {
      case 'success':
        bgColor = 'bg-green-500';
        icon = <CheckCircle className="h-5 w-5" />;
        break;
      case 'error':
        bgColor = 'bg-red-500';
        icon = <AlertCircle className="h-5 w-5" />;
        break;
      default:
        bgColor = 'bg-blue-500';
        icon = <Info className="h-5 w-5" />;
    }
    
    return (
      <div className={`flex items-center text-white p-3 rounded-md shadow-md mb-3 ${bgColor}`}>
        <div className="mr-3">{icon}</div>
        <div className="flex-grow">{message}</div>
        <button className="ml-3" onClick={() => onClose(id)}>
          <X className="h-5 w-5" />
        </button>
      </div>
    );
  };
  
  // Modal para visualização/edição de registro
  const RegistroModal = () => {
    if (!viewModal.show) return null;
    
    const registro = viewModal.data;
    const readonly = viewModal.readonly;
    
    // Calcular total de registros
    const totalRegistros = (
      parseInt(registro['Registros Nascimento'] || 0) +
      parseInt(registro['Vias Emitidas'] || 0) +
      parseInt(registro['Averbações Paternidade'] || 0) +
      parseInt(registro['Retificações'] || 0) +
      parseInt(registro['Registros Tardios'] || 0) +
      parseInt(registro['Restaurações'] || 0)
    );
    
    // Formatar data
    let dataFormatada = 'N/A';
    if (registro['Timestamp']) {
      try {
        const data = new Date(registro['Timestamp']);
        dataFormatada = data.toLocaleDateString('pt-BR') + ' ' + 
                       data.toLocaleTimeString('pt-BR');
      } catch (e) {
        console.error('Erro ao formatar data:', e);
      }
    }
    
    return (
      <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div className="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
          <div className="bg-red-900 text-white px-6 py-4 flex justify-between items-center">
            <h3 className="text-xl font-bold">
              {readonly ? `Visualizar Registro #${registro.ID}` : `Editar Registro #${registro.ID}`}
            </h3>
            <button 
              className="text-white hover:text-gray-200"
              onClick={() => setViewModal({ show: false, data: null, readonly: true })}
            >
              <X className="h-6 w-6" />
            </button>
          </div>
          
          <div className="p-6">
            <form id="editForm">
              {/* Modal content... */}
            </form>
          </div>
          
          <div className="bg-gray-100 px-6 py-4 flex justify-end gap-2">
            <button 
              className="py-2 px-4 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition"
              onClick={() => setViewModal({ show: false, data: null, readonly: true })}
            >
              Fechar
            </button>
            {!readonly && (
              <button 
                className="py-2 px-4 bg-red-900 text-white rounded-md hover:bg-red-700 transition"
                onClick={handleSaveEdit}
                disabled={isLoading}
              >
                {isLoading ? (
                  <>
                    <i className="mr-2 animate-spin"></i>Salvando...
                  </>
                ) : (
                  <>
                    <Save className="inline mr-2 h-5 w-5" />
                    Salvar Alterações
                  </>
                )}
              </button>
            )}
          </div>
        </div>
      </div>
    );
  };
  
  // Modal para confirmação de exclusão
  const DeleteConfirmModal = () => {
    if (!deleteModal.show) return null;
    
    return (
      <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div className="bg-white rounded-lg shadow-xl w-full max-w-md">
          <div className="bg-red-600 text-white px-6 py-4 flex justify-between items-center">
            <h3 className="text-xl font-bold">Confirmar Exclusão</h3>
            <button 
              className="text-white hover:text-gray-200"
              onClick={() => setDeleteModal({ show: false, id: null })}
            >
              <X className="h-6 w-6" />
            </button>
          </div>
          
          <div className="p-6">
            <div className="flex items-start">
              <AlertCircle className="text-red-600 mr-4 h-10 w-10 flex-shrink-0" />
              <div>
                <p className="mb-2">
                  Tem certeza que deseja excluir o registro <strong>#{deleteModal.id}</strong>?
                </p>
                <p className="text-red-600 font-semibold">
                  Esta ação não pode ser desfeita.
                </p>
              </div>
            </div>
          </div>
          
          <div className="bg-gray-100 px-6 py-4 flex justify-end gap-2">
            <button 
              className="py-2 px-4 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition"
              onClick={() => setDeleteModal({ show: false, id: null })}
            >
              Cancelar
            </button>
            <button 
              className="py-2 px-4 bg-red-600 text-white rounded-md hover:bg-red-700 transition"
              onClick={handleDeleteConfirm}
              disabled={isLoading}
            >
              {isLoading ? (
                <>
                  <i className="mr-2 animate-spin"></i>Excluindo...
                </>
              ) : (
                <>
                  <Trash2 className="inline mr-2 h-5 w-5" />
                  Excluir
                </>
              )}
            </button>
          </div>
        </div>
      </div>
    );
  };
  
  return (
    <div className="min-h-screen bg-gray-100 p-4">
      <header className="bg-white py-4 px-6 shadow-md rounded-lg flex flex-col md:flex-row items-center justify-between mb-6">
        <div className="flex items-center mb-4 md:mb-0">
          <img src="/api/placeholder/200/70" alt="COGEX Logo" className="h-16" />
          <h1 className="text-2xl font-bold text-red-900 ml-4 hidden md:block">
            COGEX - Semana Registre-se
          </h1>
        </div>
        <div>
          <h2 className="text-xl font-semibold text-gray-700">Sistema de Gestão de Registros</h2>
        </div>
      </header>
      
      {/* Tabs de navegação */}
      <div className="bg-white rounded-lg shadow-md mb-6">
        <div className="flex border-b">
          <button
            className={`px-4 py-3 font-medium ${
              activeTab === 'form'
                ? 'border-b-2 border-red-900 text-red-900'
                : 'text-gray-600 hover:text-red-900'
            }`}
            onClick={() => setActiveTab('form')}
          >
            <FileText className="inline mr-2 h-5 w-5" />
            Novo Registro
          </button>
          <button
            className={`px-4 py-3 font-medium ${
              activeTab === 'list'
                ? 'border-b-2 border-red-900 text-red-900'
                : 'text-gray-600 hover:text-red-900'
            }`}
            onClick={() => setActiveTab('list')}
          >
            <List className="inline mr-2 h-5 w-5" />
            Consultar Registros
          </button>
        </div>
      </div>
      
      {/* Conteúdo das abas */}
      <div className="tab-content">
        {activeTab === 'form' ? <FormTab /> : <ListTab />}
      </div>
      
      {/* Sistema de toast notifications */}
      <div className="fixed top-5 right-5 z-50">
        {toasts.map(toast => (
          <Toast
            key={toast.id}
            id={toast.id}
            message={toast.message}
            type={toast.type}
            onClose={removeToast}
          />
        ))}
      </div>
      
      {/* Modais */}
      <RegistroModal />
      <DeleteConfirmModal />
      
      {/* Botão voltar ao topo */}
      <button
        className="fixed bottom-5 right-5 bg-red-900 text-white p-3 rounded-full shadow-lg hover:bg-red-700 transition"
        onClick={() => window.scrollTo({ top: 0, behavior: 'smooth' })}
      >
        <ArrowUp className="h-5 w-5" />
      </button>
    </div>
  );
};

export default CogexRegistreApp;
